@model GymCRM.ViewModels.AdminDashboardViewModel
@{
    ViewData["Title"] = "لوحة التحكم";
}

<div class="d-flex justify-content-between align-items-center mb-3" data-aos="fade-down" data-aos-duration="500">
    <h3 class="mb-0">لوحة التحكم</h3>
    <div class="d-flex gap-2">
        <a class="btn btn-primary" href="/admin/bookings/create"><i class="bi bi-plus-circle me-1"></i> حجز لعميل</a>
        <a class="btn btn-outline-secondary" href="/admin/sessions/create"><i class="bi bi-plus-square me-1"></i> جلسة جديدة</a>
    </div>
</div>

<div class="card shadow-sm mb-3 border-0" data-aos="fade-up" data-aos-duration="600">
  <div class="card-body">
    <form class="row g-3" method="get" action="/admin/dashboard" id="filterForm">
      <div class="col-md-4">
        <label class="form-label">الدولة</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-globe"></i></span>
          <select id="countrySel" name="countryId" class="form-select">
            <option value="">الكل</option>
            @foreach (var countryItem in (Model?.Countries ?? Enumerable.Empty<Microsoft.AspNetCore.Mvc.Rendering.SelectListItem>()))
            {
                var isSelected = Model?.SelectedCountryId.HasValue == true
                                 && countryItem.Value == Model.SelectedCountryId.Value.ToString();
                if (isSelected)
                {
                    @:<option value="@countryItem.Value" selected="selected">@countryItem.Text</option>
                }
                else
                {
                    @:<option value="@countryItem.Value">@countryItem.Text</option>
                }
            }
          </select>
        </div>
      </div>

      <div class="col-md-4">
        <label class="form-label">المدينة</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-building"></i></span>
          @if (Model?.SelectedCountryId.HasValue == true)
          {
              <select id="citySel" name="cityId" class="form-select">
                  <option value="">الكل</option>
              </select>
          }
          else
          {
              <select id="citySel" name="cityId" class="form-select" disabled="disabled">
                  <option value="">الكل</option>
              </select>
          }
        </div>
      </div>

      <div class="col-md-4">
        <label class="form-label">الفرع</label>
        <div class="input-group">
          <span class="input-group-text"><i class="bi bi-geo-alt"></i></span>
          @if (Model?.SelectedCityId.HasValue == true)
          {
              <select id="branchSel" name="branchId" class="form-select">
                  <option value="">الكل</option>
              </select>
          }
          else
          {
              <select id="branchSel" name="branchId" class="form-select" disabled="disabled">
                  <option value="">الكل</option>
              </select>
          }
        </div>
      </div>

      <div class="col-12 d-flex gap-2">
        <button class="btn btn-danger" type="submit">
          <i class="bi bi-funnel me-1"></i> تطبيق
        </button>
        <a class="btn btn-outline-secondary" href="/admin/dashboard">
          <i class="bi bi-arrow-repeat"></i> إعادة تعيين
        </a>
      </div>
    </form>
  </div>
</div>

@if (Model != null)
{
  <div class="row g-3">
    <div class="col-md-4" data-aos="zoom-in" data-aos-delay="50">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">إجمالي الاشتراكات</div>
            <div class="fs-3 fw-bold">@Model.TotalSubs</div>
          </div>
          <i class="bi bi-people fs-1 text-secondary opacity-50"></i>
        </div>
      </div>
    </div>

    <div class="col-md-4" data-aos="zoom-in" data-aos-delay="100">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">اشتراكات نشطة</div>
            <div class="fs-3 fw-bold">@Model.ActiveSubs</div>
          </div>
          <i class="bi bi-activity fs-1 text-success opacity-50"></i>
        </div>
      </div>
    </div>

    <div class="col-md-4" data-aos="zoom-in" data-aos-delay="150">
      <div class="card shadow-sm border-0">
        <div class="card-body d-flex align-items-center justify-content-between">
          <div>
            <div class="text-muted">إيرادات مدفوعة</div>
            <div class="fs-3 fw-bold">@Model.Revenue.ToString("0.##") ر.س</div>
          </div>
          <i class="bi bi-cash-coin fs-1 text-warning opacity-50"></i>
        </div>
      </div>
    </div>

    <div class="col-md-6" data-aos="fade-up" data-aos-delay="100">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="mb-3">توزيع حسب الخطة</h5>
          @if (Model.PerPlan?.Any() == true)
          {
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light"><tr><th>الخطة</th><th>عدد</th><th>إيراد مدفوع</th></tr></thead>
                <tbody>
                  @foreach (var planStat in Model.PerPlan)
                  {
                    <tr>
                      <td>@planStat.Plan</td>
                      <td>@planStat.Count</td>
                      <td>@planStat.Revenue.ToString("0.##")</td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
          else
          {
            <div class="text-muted">لا توجد بيانات.</div>
          }
        </div>
      </div>
    </div>

    <div class="col-md-6" data-aos="fade-up" data-aos-delay="150">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h5 class="mb-3">أعلى المدن (عدد الاشتراكات)</h5>
          @if (Model.PerCity?.Any() == true)
          {
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle">
                <thead class="table-light"><tr><th>المدينة</th><th>عدد</th></tr></thead>
                <tbody>
                  @foreach (var cityStat in Model.PerCity)
                  {
                    <tr><td>@cityStat.City</td><td>@cityStat.Count</td></tr>
                  }
                </tbody>
              </table>
            </div>
          }
          else
          {
            <div class="text-muted">لا توجد بيانات.</div>
          }
        </div>
      </div>
    </div>
  </div>

  @* تفاصيل الفرع المختار *@
  if (Model.SelectedBranchId.HasValue && (Model.BranchSubscriptions?.Any() ?? false))
  {
    <div class="card shadow-sm mt-3 border-0" data-aos="fade-up" data-aos-delay="200">
      <div class="card-body">
        <h5 class="mb-3">تفاصيل الفرع — اشتراكات العملاء</h5>
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>#</th><th>العميل</th><th>الخطة</th><th>البداية</th><th>الانتهاء</th><th>الحالة</th>
              </tr>
            </thead>
            <tbody>
              @foreach (var subRow in Model.BranchSubscriptions)
              {
                <tr>
                  <td>@subRow.SubscriptionId</td>
                  <td>@subRow.Customer</td>
                  <td>@subRow.Plan</td>
                  <td>@(subRow.StartDate?.ToString("yyyy/MM/dd") ?? "-")</td>
                  <td>@(subRow.EndDate?.ToString("yyyy/MM/dd") ?? "-")</td>
                  <td>@subRow.Status</td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    </div>
  }
}

@section Scripts {
<script>
  // حفظ الاختيارات لو رجعت من السيرفر
  const selCountry = '@(Model?.SelectedCountryId?.ToString() ?? "")';
  const selCity    = '@(Model?.SelectedCityId?.ToString() ?? "")';
  const selBranch  = '@(Model?.SelectedBranchId?.ToString() ?? "")';

  const countrySel = document.getElementById('countrySel');
  const citySel    = document.getElementById('citySel');
  const branchSel  = document.getElementById('branchSel');

  function setBusy(el, busy){
    if (busy) {
      el.innerHTML = '<option value="">جاري التحميل…</option>';
      el.setAttribute('disabled', 'disabled');
    } else {
      el.removeAttribute('disabled');
    }
  }

  async function loadCities(){
    citySel.innerHTML   = '<option value="">الكل</option>';
    branchSel.innerHTML = '<option value="">الكل</option>';
    branchSel.setAttribute('disabled', 'disabled');

    const cid = countrySel.value;
    if(!cid){ citySel.setAttribute('disabled','disabled'); return; }

    setBusy(citySel, true);
    try {
      const r  = await fetch(`/admin/filter/cities?countryId=${cid}`);
      const js = await r.json();
      citySel.innerHTML = '<option value="">الكل</option>' + js.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
      setBusy(citySel, false);

      if (selCity){
        citySel.value = selCity;
        await loadBranches();
      }
    } catch {
      citySel.innerHTML = '<option value="">تعذّر التحميل</option>';
    }
  }

  async function loadBranches(){
    branchSel.innerHTML = '<option value="">الكل</option>';
    const cty = citySel.value;
    if(!cty){ branchSel.setAttribute('disabled','disabled'); return; }

    setBusy(branchSel, true);
    try {
      const r  = await fetch(`/admin/filter/branches?cityId=${cty}`);
      const js = await r.json();
      branchSel.innerHTML = '<option value="">الكل</option>' + js.map(x => `<option value="${x.id}">${x.name}</option>`).join('');
      setBusy(branchSel, false);

      if (selBranch) branchSel.value = selBranch;
    } catch {
      branchSel.innerHTML = '<option value="">تعذّر التحميل</option>';
    }
  }

  countrySel.addEventListener('change', ()=>{ loadCities(); });
  citySel.addEventListener('change', ()=>{ loadBranches(); });

  if (selCountry){ countrySel.value = selCountry; loadCities(); }
</script>
}
